<script>
  // OPTIONAL: add your Google Maps API key to improve accuracy by snapping to the nearest panorama
  const GOOGLE_MAPS_API_KEY = ""; // e.g. "AIzaSyA...."  (leave blank to skip pano lookup)

  function clampHeading(h) {
    const n = Number(h);
    return Number.isFinite(n) ? ((n % 360) + 360) % 360 : 0;
  }

  function buildPanoUrl(lat, lng, heading) {
    const h = clampHeading(heading);
    return `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}&heading=${h}&pitch=0&fov=80`;
  }

  // Bearing from pano -> target (in degrees). Uses turf, which you already load.
  function bearingDeg(fromLng, fromLat, toLng, toLat) {
    const b = turf.bearing(turf.point([fromLng, fromLat]), turf.point([toLng, toLat]));
    return clampHeading(b);
  }

  async function getNearestStreetViewLatLng(lat, lng, radiusMeters = 100) {
    if (!GOOGLE_MAPS_API_KEY) return null;
    const url = `https://maps.googleapis.com/maps/api/streetview/metadata?location=${lat},${lng}&radius=${radiusMeters}&key=${GOOGLE_MAPS_API_KEY}`;
    try {
      const r = await fetch(url);
      if (!r.ok) return null;
      const meta = await r.json();
      if (meta && meta.status === "OK" && meta.location) {
        return { lat: meta.location.lat, lng: meta.location.lng };
      }
    } catch (_) {}
    return null;
  }

  // Build the most reliable Street View link we can for a property.
  // 1) Use provided pano coords if valid
  // 2) Else try to snap to nearest pano (if API key present)
  // 3) Else fall back to a Maps search with Street View layer
  async function createStreetViewUrlSmart(props, propCoords /* [lng, lat] */) {
    const propLng = Number(propCoords?.[0]);
    const propLat = Number(propCoords?.[1]);

    // Case 1: you provided pano coords in the data
    const panoLat = Number(props.pano_latitude);
    const panoLng = Number(props.pano_longitude);
    const havePano = Number.isFinite(panoLat) && Number.isFinite(panoLng);
    const haveProp = Number.isFinite(propLat) && Number.isFinite(propLng);

    if (havePano) {
      const heading = haveProp ? bearingDeg(panoLng, panoLat, propLng, propLat) : clampHeading(props.heading);
      return buildPanoUrl(panoLat, panoLng, heading);
    }

    // Case 2: try to snap to the nearest available pano around the property
    if (haveProp) {
      const nearest = await getNearestStreetViewLatLng(propLat, propLng, 120); // widen to ~120m for industrial parks
      if (nearest) {
        const heading = bearingDeg(nearest.lng, nearest.lat, propLng, propLat);
        return buildPanoUrl(nearest.lat, nearest.lng, heading);
      }

      // Case 3: fallback that often opens directly in SV if available
      return `https://www.google.com/maps/search/?api=1&query=${propLat},${propLng}&layer=c`;
    }

    return null;
  }

  // Use the smarter URL builder when adding markers/popups
  async function addMarkersToMap(geojson) {
    for (const feature of geojson.features) {
      const coords = feature.geometry.coordinates;
      const props = feature.properties;

      // Build Street View URL (may call Google metadata if key provided)
      const streetViewUrl = await createStreetViewUrlSmart(props, coords);
      const popupHtml = createPopupHTML(props, coords, streetViewUrl);

      const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(popupHtml);
      new mapboxgl.Marker({ color: '#3887be' }).setLngLat(coords).setPopup(popup).addTo(map);
    }
  }

  // Update popup builder to accept the precomputed streetViewUrl
  function createPopupHTML(props, coords, streetViewUrl) {
    const name = props.project_name || "Unnamed";
    const address = props.project_address || "No address provided";
    const assetClass = props.asset_class || "";
    const sqNum = Number(String(props.sq_ft || "").replace(/[^\d.-]/g, ""));
    const sqFt = Number.isFinite(sqNum) ? `${Math.round(sqNum).toLocaleString()} Sq Ft` : "";
    const units = props.units ? `${props.units} Units` : "";
    const photoUrl = props.photo_url;

    const googleMapsUrl =
      `https://www.google.com/maps/dir/?api=1&destination=${coords[1]},${coords[0]}&travelmode=driving&destination_place_name=${encodeURIComponent(name || 'Property')}`;

    const imageHtml = photoUrl
      ? `<div style="margin:10px 0; max-height:180px; overflow:hidden;">
           ${streetViewUrl ? `<a href="${streetViewUrl}" target="_blank" rel="noopener noreferrer">` : ``}
           <img src="${photoUrl}" alt="Photo of ${name}" loading="lazy">
           ${streetViewUrl ? `</a>` : ``}
         </div>`
      : "";

    const svHtml = streetViewUrl
      ? `<a href="${streetViewUrl}" class="nav-link" target="_blank">Open Street View</a>`
      : ``;

    return `
      <div class="property-popup">
        <h3>${name}</h3>
        ${imageHtml}
        <p><strong>Address:</strong> ${address}</p>
        ${assetClass ? `<p><strong>Asset Class:</strong> ${assetClass}</p>` : ""}
        ${sqFt ? `<p><strong>Sq Ft:</strong> ${sqFt}</p>` : ""}
        ${units ? `<p><strong>Units:</strong> ${units}</p>` : ""}
        <a href="${googleMapsUrl}" class="nav-link" target="_blank">Navigate in Google Maps</a>
        ${svHtml}
      </div>`;
  }
</script>
